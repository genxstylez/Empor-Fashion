{% extends 'product/admin/base.html' %}
{% load i18n %}
{% block js %}
<link rel="stylesheet" href="{{ STATIC_URL }}js/Jcrop/css/jquery.Jcrop.css" type="text/css" />
<script src="{{ STATIC_URL }}js/jquery.formset.js"></script>
<script src="{{ STATIC_URL }}js/jquery.livequery.js"></script>
<script src="{{ STATIC_URL }}js/Jcrop/js/jquery.Jcrop.min.js"></script>
<script>
$(function(){
    // formset
    var deleteText = '刪除';
    var addText = '新增';

    $('.child-form').formset({
        formCssClass: 'child-form',
        prefix: 'child',
        deleteText: deleteText,
        addText: addText
    });

    $('.product-image').formset({
        formCssClass: 'product-image',
        prefix: 'product_image',
        addText: '',
        deleteText: '',
        addCssClass: 'image_add'
    });

    $('input[name="has_options"]').change(function() {
        if($(this).is(':checked'))
            $('#child_formset').show();
        else
            $('#child_formset').hide();
    });

    $('input[name="has_options"]').livequery(function() {
        if($(this).is(':checked'))
            $('#child_formset').show();
        else
            $('#child_formset').hide();
    });
    
    $('#p_edit-form').submit(function() {
        if($('.item_img input[type="checkbox"]:checked').length != 1)
            $('.item_img input[type="checkbox"]').removeAttr('checked');
            $('.item_img input[type="checkbox"]:first').attr('checked', 'checked');
    });

    $('.item_img input[type="checkbox"]').livequery('change', function() {
        $(this).parent().siblings().find('input[type="checkbox"]').removeAttr('checked');
    });

    $('.item_img .img_thumb').livequery(function() {
        if($(this).attr('src') == '')
            $(this).attr('src', $(this).siblings('.image_url').val());
    });

    $('.optiongroup').on('change', function () {
        var that = $(this)
        $('.options').empty();
        $.get('/empor/admin/render_options/'+$(this).val(), function(response) {
            for (var key in response) {
                $('select.options').append('<option value="'+ response[key].id +'">'+ response[key].name+'</option>');
            }
            $('.options').removeAttr('disabled');
        });
    });

    var management = $('input[name="product-TOTAL_FORMS"]');
    var product_formset = $('#product_image_formset');

    product_formset.livequery(function() {
        if($('.img_thumb').attr('src') != '')
            $(this).show();
    });

    var uploader = new plupload.Uploader({
        runtimes : 'gears,html5, flash',
        browse_button: 'image_button', 
        container : 'uploader',
        drop_element: 'uploader',
        multipart: true,
        headers: {'X-Requested-With': 'XMLHttpRequest', 'X_CSRFToken' : $('input[name*="csrfmiddlewaretoken"]').val()},
        url: '/empor/admin/_upload/',
        max_file_size: '10mb',
        chunk_size: '1mb',
        unique_names: true,
        multi_selection : true
    });

    uploader.init();

    var files_count;

    uploader.bind('FilesAdded', function(up, files) {
        uploader.start();
        files_count = files.length;
    });

    uploader.bind('FileUploaded', function(up, file, response) {
        response = JSON.parse(response.response);
        window.a = response;
        product_formset.find('.item_img:last .img_thumb').attr('src', response.file);
        product_formset.find('.item_img:last .image_url').val(response.file);
        product_formset.find('.item_img:last .image_id').val(response.file_id);
        if(files_count != product_formset.find('.item_img').length)
            $('a.image_add').click();
    });
    
    uploader.bind('UploadComplete', function() {
        product_formset.find('.item_img:first input[type="checkbox"]').attr('checked', 'checked'); 
        product_formset.fadeIn();
    });
    
    var thumb_uploader = new plupload.Uploader({
        runtimes : 'html5, flash',
        browse_button: 'thumb_button', 
        container : 'thumb',
        headers: {'X-Requested-With': 'XMLHttpRequest', 'X_CSRFToken' : $('input[name*="csrfmiddlewaretoken"]').val()},
        url: '/empor/admin/_thumb_upload/',
        max_file_size: '10mb',
        chunk_size: '1mb',
        unique_names: true,
    });
    
    thumb_uploader.init();

    thumb_uploader.bind('FilesAdded', function(up, files) {
        $.each(files, function(i, file) {
            $('.file_name').html(file.name);
        });
    });
    $('#thumb .button_s').click(function() {
        thumb_uploader.start();
        return false;
    });

    thumb_uploader.bind('FileUploaded', function(up, file, response) {
        response = JSON.parse(response.response);
        $('.img_cut_box img').attr('src', response.file);
        $('#thumb .thumb_url').val(response.file);
        $('#thumb input[name="id"]').val(response.file_id);
        $('.img_cut_box img').Jcrop({
            onSelect: showCoords,
            minSize: [40, 40],
            maxSize: [100, 100],
            aspectRatio: 1
        });
    });

    function showCoords(c) {
        $('#thumb input[name="x1"]').val(c.x);
        $('#thumb input[name="y1"]').val(c.y);
        $('#thumb input[name="x2"]').val(c.x2);
        $('#thumb input[name="y2"]').val(c.y2);
    }
});
</script>
{% endblock %}
{% block content %}
{{ collection.name }}
{% for product in products %}
{{ product.name }}
{% endfor %}
<form id="p_edit-form" method="post" class="form-inline">
{% csrf_token %}
    <div class="left">
        <h3>上傳商品圖</h3>
        <div class="control-group">
            <button id="image_button">browse</button>
            <div id="uploader" class="upload_box">Drag photos from your computer here</div>
        </div>
        <div id="product_image_formset" class="control-group" style="display:none;">
            {{ product_image_formset.management_form }}
                {% for form in product_image_formset.forms %}
                <div class="item_img product-image">
                    <div class="hide"><a href="#"><img src="images/remove.png"></a></div>
                    <img class="img_thumb" src="">
                    {{ form.id }}
                    {{ form.url }}
                    {{ form.main }}
                </div>
                {% endfor %}
        </div>
        <h3>上傳商品樣式縮圖</h3>
        <div id="thumb" class="control-group">
            {{ thumb_form }}
            <input class="input-file" id="thumb_button" type="button" value="選擇檔案"/>
            <span class="file_name"></span>
            <div class="form-actions_left"><a href="#" class="button_s">上傳</a></div>
        </div>
        <div class="control-group">
            <div class="img_cut_box"><img src="images/item/10064238_373145_1000.jpg"></div>
        </div>
    </div>
            <div class="right">
                <h3>{% trans 'Product Information' %}</h3>
                {% for field in product_form %}
                <div class="control-group">
                    <label class="control-label">{{ field.label }}</label>
                    <div class="controls">{{ field }}</div>
                    {{ field.errors }}
                </div>
                {% endfor %}
                {{ child_formset.management_form }}
                {{ child_formset.errors }}
                <div id="child_formset">
                    {% for form in child_formset.forms %}
                    <div class="child-form control-group">
                        <label class="control-label">{% trans 'Stock' %}</label>
                        <div class="controls">
                        {% for field in form %}
                        {{ field }}
                        {{ field.errors }}
                        {% endfor %}
                        </div>
                        <a href="#" class="add_btn"><img src="images/add.png"></a>
                    </div>
                    {% endfor %}
                </div> 
                <br clear="all">
            </div>
            <div class="form-actions">
                <input type="submit" class="button" value="{% trans 'Save' %}" />
            </div>
        </form>
</form>
{% endblock %}
